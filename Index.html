<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>VocaPro V32</title>
    <style>
        :root { 
            --primary: #007AFF; --success: #34C759; --danger: #FF3B30; 
            --bg: #F2F2F7; --card-bg: rgba(255, 255, 255, 0.9); --text: #1C1C1E;
        }
        body.dark-mode { --bg: #000000; --card-bg: rgba(44, 44, 46, 0.9); --text: #F2F2F7; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; color: var(--text);
            transition: background 0.3s; overflow-x: hidden; height: 100vh;
        }

        .glass { backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); }
        
        .app-header { width: 100%; padding: 50px 20px 10px 20px; box-sizing: border-box; display: flex; justify-content: space-between; align-items: center; }
        .container { width: 100%; max-width: 500px; padding: 0 15px 120px 15px; box-sizing: border-box; }
        
        .box { background: var(--card-bg); padding: 18px; border-radius: 20px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        #login-screen { 
            position: fixed; inset: 0; 
            background: linear-gradient(135deg, #007AFF, #00C6FF); 
            z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 25px; 
        }
        .login-box { background: white; padding: 40px 30px; border-radius: 35px; width: 100%; max-width: 350px; text-align: center; color: #000; }

        .tab-bar { 
            position: fixed; bottom: 0; width: 100%; max-width: 500px; height: 85px; 
            background: var(--card-bg); display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid rgba(128,128,128,0.2); z-index: 1000; padding-bottom: env(safe-area-inset-bottom);
        }
        .tab-item { display: flex; flex-direction: column; align-items: center; color: #8E8E93; font-size: 10px; font-weight: 600; cursor: pointer; flex: 1; }
        .tab-item.active { color: var(--primary); }
        .tab-icon { font-size: 24px; margin-bottom: 4px; }

        .filter-box { display: flex; justify-content: space-between; align-items: center; background: rgba(128,128,128,0.05); padding: 10px; border-radius: 15px; margin-bottom: 10px; }
        .filter-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; font-weight: bold; }
        .filter-item input { width: 18px; height: 18px; margin-bottom: 4px; }

        .card-container { width: 100%; height: 280px; perspective: 1000px; margin: 10px 0; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .flipped { transform: rotateY(180deg); }
        .card-front, .card-back { 
            position: absolute; inset: 0; backface-visibility: hidden; border-radius: 30px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            padding: 25px; box-sizing: border-box; text-align: center; background: var(--card-bg); color: var(--text); box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .card-back { transform: rotateY(180deg); }
        .card-img { max-width: 100%; max-height: 130px; border-radius: 15px; margin-bottom: 10px; object-fit: contain; }
        .card-text { font-size: 26px; font-weight: 800; }

        input, select { width: 100%; padding: 12px; margin: 5px 0; border: none; background: rgba(128,128,128,0.1); border-radius: 12px; color: var(--text); font-size: 16px; box-sizing: border-box; }
        button { padding: 12px; border-radius: 12px; border: none; font-size: 14px; font-weight: 700; cursor: pointer; }
        .btn-blue { background: var(--primary); color: white; width: 100%; }
        .btn-gray { background: rgba(128,128,128,0.2); color: var(--text); }
        .btn-red { background: var(--danger); color: white; }

        .list-row { display: grid; grid-template-columns: 1fr 1fr 40px; gap: 8px; padding: 10px 0; border-bottom: 1px solid rgba(128,128,128,0.1); }
        .lvl-pill { background: var(--primary); color: white; padding: 3px 10px; border-radius: 15px; font-size: 10px; position: absolute; top: 15px; right: 20px; }
        
        #image-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .mixer-input-letter { display: inline-block; padding: 5px 10px; margin: 3px; background: var(--primary); color: white; border-radius: 8px; cursor: pointer; font-size: 18px; }
    </style>
</head>
<body>

<div id="image-overlay" onclick="this.style.display='none'"><img id="overlay-img" src="" style="max-width:95%; max-height:90%;"></div>

<div id="login-screen">
    <div class="login-box glass">
        <h1 style="font-size: 36px; margin-bottom: 5px;">VocaPro</h1>
        <p style="opacity: 0.6; margin-bottom: 25px;">W√§hle deinen Account</p>
        <select id="userSelect"></select>
        <input type="text" id="newUserName" placeholder="Oder neuer Name...">
        <button class="btn-blue" style="margin-top: 15px; padding: 16px;" onclick="login()">Starten</button>
    </div>
</div>

<div id="app-content" style="display:none; width: 100%;">
    <div class="app-header">
        <span id="displayUserName" style="font-size: 18px; font-weight: 800;"></span>
        <div style="display: flex; gap: 8px;">
            <button class="btn-gray" onclick="toggleDarkMode()">üåì</button>
            <button class="btn-gray" onclick="logout()">Account</button>
        </div>
    </div>

    <div class="container">
        <div class="box glass">
            <select id="setSelect" onchange="switchSet()"></select>
            <div style="display:grid; grid-template-columns: 1fr 45px; gap:8px; margin-top:10px;">
                <input type="text" id="setNameInput" placeholder="Set-Name...">
                <button class="btn-blue" onclick="handleCreateSet()">+</button>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px;">
                <button class="btn-gray" onclick="handleRenameSet()">‚úèÔ∏è</button>
                <button class="btn-red" onclick="handleDeleteSet()" style="opacity:0.8;">üóëÔ∏è</button>
            </div>
        </div>

        <div id="view-main">
            <div class="filter-box">
                <div class="filter-item">L1<input type="checkbox" class="lvl-check" value="1" checked onchange="renderUI()"></div>
                <div class="filter-item">L2<input type="checkbox" class="lvl-check" value="2" checked onchange="renderUI()"></div>
                <div class="filter-item">L3<input type="checkbox" class="lvl-check" value="3" checked onchange="renderUI()"></div>
                <div class="filter-item">L4<input type="checkbox" class="lvl-check" value="4" checked onchange="renderUI()"></div>
                <div class="filter-item">L5<input type="checkbox" class="lvl-check" value="5" checked onchange="renderUI()"></div>
            </div>

            <div class="card-container">
                <div class="card-inner" id="cardInner">
                    <div class="card-front glass" id="cardFront" onclick="handleCardFlip()"></div>
                    <div class="card-back glass" id="cardBack" onclick="handleCardFlip()"></div>
                </div>
            </div>

            <div id="mixer-controls" style="display:none;" class="box glass">
                <div id="mixerDisplay" style="text-align:center; min-height:45px; border-bottom:2px solid var(--primary); margin-bottom:15px; display:flex; justify-content:center; align-items:center; flex-wrap:wrap;"></div>
                <div id="mixerLetterPool" style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom:15px;"></div>
                <button class="btn-gray" style="width:100%; font-size:12px;" onclick="resetMixer()">üóëÔ∏è Alles zur√ºcksetzen</button>
            </div>

            <div id="test-controls" style="display:none;" class="box glass">
                <input type="text" id="testInput" placeholder="Antwort..." onkeyup="if(event.key==='Enter') evaluateTest()">
                <div id="testFeedback" style="text-align:center; height:25px; font-weight:bold; margin: 5px 0;"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <button class="btn-blue" onclick="evaluateTest()">Pr√ºfen</button>
                    <button class="btn-gray" onclick="navigate(1)">Weiter ‚û°</button>
                </div>
            </div>

            <div id="learn-controls" class="box glass" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn-red" onclick="setCardStatus(false)">‚ùå L1</button>
                <button style="background:var(--success); color:white;" onclick="setCardStatus(true)">‚úÖ +1</button>
                <button class="btn-gray" onclick="navigate(-1)">‚¨Ö</button>
                <button class="btn-gray" onclick="navigate(1)">‚û°</button>
            </div>
        </div>

        <div id="view-list" style="display:none;">
            <div class="box glass">
                <h3 style="margin-top:0;">Neu hinzuf√ºgen</h3>
                <input type="text" id="addFront" placeholder="Vorderseite">
                <input type="text" id="addBack" placeholder="R√ºckseite">
                <input type="file" id="addFile" accept="image/*" style="background:none; font-size:12px;">
                <button class="btn-blue" style="margin-top:10px;" onclick="handleAddCard()">Hinzuf√ºgen</button>
            </div>
            
            <div class="box glass">
                <input type="text" id="listSearch" placeholder="Suchen..." onkeyup="refreshListView()">
                <div id="listBody" style="max-height: 350px; overflow-y: auto; margin-top:10px;"></div>
            </div>

            <div class="box glass" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn-gray" onclick="exportJSON()">üíæ Export</button>
                <button class="btn-gray" onclick="document.getElementById('importFile').click()">üìÇ Import</button>
                <input type="file" id="importFile" style="display:none;" onchange="importJSON(event)">
            </div>
        </div>
    </div>

    <div class="tab-bar glass">
        <div class="tab-item active" id="tab-learn" onclick="changeAppMode('learn')">
            <span class="tab-icon">üìñ</span><span>Lernen</span>
        </div>
        <div class="tab-item" id="tab-mixer" onclick="changeAppMode('mixer')">
            <span class="tab-icon">üîÄ</span><span>Mixer</span>
        </div>
        <div class="tab-item" id="tab-test" onclick="changeAppMode('test')">
            <span class="tab-icon">üìù</span><span>Test</span>
        </div>
        <div class="tab-item" id="tab-list" onclick="changeAppMode('list')">
            <span class="tab-icon">üóÇÔ∏è</span><span>Liste</span>
        </div>
    </div>
</div>

<script>
    let allData = JSON.parse(localStorage.getItem('voca_v32_data')) || {};
    let currentUser = localStorage.getItem('voca_v32_user') || "";
    let currentSet = "", index = 0, appMode = 'learn', lastImg = "";
    let mixerCurrentArray = []; 

    document.getElementById('addFile').onchange = e => {
        const r = new FileReader(); r.onload = ev => lastImg = ev.target.result; r.readAsDataURL(e.target.files[0]);
    };

    function init() {
        const sel = document.getElementById('userSelect'); sel.innerHTML = '<option value="">W√§hle Account</option>';
        Object.keys(allData).forEach(u => sel.innerHTML += `<option value="${u}">${u}</option>`);
        if(currentUser && allData[currentUser]) showApp();
    }

    function login() {
        let name = document.getElementById('newUserName').value.trim() || document.getElementById('userSelect').value;
        if(!name || name.includes('W√§hle')) return;
        if(!allData[name]) allData[name] = { "Standard": [] };
        currentUser = name; localStorage.setItem('voca_v32_user', currentUser); save(); showApp();
    }

    function logout() { localStorage.removeItem('voca_v32_user'); location.reload(); }

    function showApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        document.getElementById('displayUserName').innerText = "Hi, " + currentUser;
        currentSet = Object.keys(allData[currentUser])[0] || "Standard";
        renderUI();
    }

    function save() { localStorage.setItem('voca_v32_data', JSON.stringify(allData)); }

    function getFiltered() {
        const lvls = Array.from(document.querySelectorAll('.lvl-check:checked')).map(c => parseInt(c.value));
        return (allData[currentUser][currentSet] || []).filter(c => lvls.includes(c.level || 1));
    }

    function renderUI() {
        const sSel = document.getElementById('setSelect'); sSel.innerHTML = "";
        Object.keys(allData[currentUser]).forEach(s => sSel.innerHTML += `<option value="${s}" ${s===currentSet?'selected':''}>${s}</option>`);

        document.getElementById('view-main').style.display = appMode==='list' ? 'none' : 'block';
        document.getElementById('view-list').style.display = appMode==='list' ? 'block' : 'none';
        
        ['mixer-controls','test-controls','learn-controls'].forEach(id => document.getElementById(id).style.display = 'none');
        if(appMode==='learn') document.getElementById('learn-controls').style.display = 'grid';
        else if(appMode==='mixer') document.getElementById('mixer-controls').style.display = 'block';
        else if(appMode==='test') document.getElementById('test-controls').style.display = 'block';

        const cards = getFiltered();
        const fDiv = document.getElementById('cardFront'), bDiv = document.getElementById('cardBack');
        document.getElementById('cardInner').classList.remove('flipped');
        document.getElementById('testFeedback').innerText = "";
        document.getElementById('testInput').value = "";

        if(!cards.length) { fDiv.innerHTML = "Keine Karten"; bDiv.innerHTML = ""; return; }
        if(index >= cards.length) index = 0;
        const c = cards[index];
        const imgH = c.img ? `<img src="${c.img}" class="card-img" onclick="event.stopPropagation(); document.getElementById('overlay-img').src='${c.img}'; document.getElementById('image-overlay').style.display='flex'">` : "";
        fDiv.innerHTML = `<div class="lvl-pill">Lvl ${c.level}</div>${imgH}<div class="card-text">${c.f}</div>`;
        bDiv.innerHTML = `<div class="card-text">${c.b}</div>`;

        if(appMode==='mixer') setupMixer(c.b);
        if(appMode==='list') refreshListView();
    }

    function setupMixer(word) {
        mixerCurrentArray = [];
        const pool = document.getElementById('mixerLetterPool'); pool.innerHTML = "";
        document.getElementById('mixerDisplay').innerHTML = "";
        word.split('').sort(() => Math.random()-0.5).forEach((l, i) => {
            const b = document.createElement('button');
            b.innerText = l; b.className = "btn-gray"; b.id = "mixer-p-" + i;
            b.onclick = () => {
                mixerCurrentArray.push({ char: l, originalId: b.id });
                b.style.visibility = "hidden";
                updateMixerDisplay(word);
            };
            pool.appendChild(b);
        });
    }

    function updateMixerDisplay(word) {
        const display = document.getElementById('mixerDisplay'); display.innerHTML = "";
        mixerCurrentArray.forEach((item, idx) => {
            const s = document.createElement('span'); s.className = "mixer-input-letter"; s.innerText = item.char;
            s.onclick = () => {
                document.getElementById(item.originalId).style.visibility = "visible";
                mixerCurrentArray.splice(idx, 1);
                updateMixerDisplay(word);
            };
            display.appendChild(s);
        });
        const currentString = mixerCurrentArray.map(i => i.char).join('');
        if(currentString.length === word.length) {
            if(currentString.toLowerCase() === word.toLowerCase()) {
                display.style.color = "var(--success)";
                setTimeout(() => navigate(1), 600);
            } else { display.style.color = "var(--danger)"; setTimeout(() => resetMixer(), 800); }
        } else { display.style.color = "inherit"; }
    }

    function resetMixer() { const cards = getFiltered(); if(cards[index]) setupMixer(cards[index].b); }

    function evaluateTest() {
        const cards = getFiltered(); if(!cards[index]) return;
        const c = cards[index];
        const input = document.getElementById('testInput').value.trim().toLowerCase();
        const fb = document.getElementById('testFeedback');
        if(input === c.b.toLowerCase()) { fb.style.color="var(--success)"; fb.innerText="Richtig!"; c.level=Math.min(c.level+1,5); save(); setTimeout(()=>navigate(1), 1000); }
        else { fb.style.color="var(--danger)"; fb.innerText="Falsch! L√∂sung: "+c.b; c.level=1; save(); document.getElementById('cardInner').classList.add('flipped'); }
    }

    function handleAddCard() {
        const f = document.getElementById('addFront').value, b = document.getElementById('addBack').value;
        if(f && b) { allData[currentUser][currentSet].push({f, b, img: lastImg, level: 1}); lastImg = ""; document.getElementById('addFile').value=""; document.getElementById('addFront').value=""; document.getElementById('addBack').value=""; save(); refreshListView(); }
    }

    function refreshListView() {
        const body = document.getElementById('listBody'); body.innerHTML = "";
        const search = document.getElementById('listSearch').value.toLowerCase();
        (allData[currentUser][currentSet] || []).forEach((c, i) => {
            if(c.f.toLowerCase().includes(search) || c.b.toLowerCase().includes(search)) {
                body.innerHTML += `<div class="list-row">
                    <input value="${c.f}" onchange="allData[currentUser][currentSet][${i}].f=this.value;save()">
                    <input value="${c.b}" onchange="allData[currentUser][currentSet][${i}].b=this.value;save()" style="color:var(--primary); font-weight:bold;">
                    <button class="btn-red" onclick="allData[currentUser][currentSet].splice(${i},1);save();refreshListView()" style="padding:5px;">X</button>
                </div>`;
            }
        });
    }

    function handleRenameSet() {
        const n = document.getElementById('setNameInput').value.trim();
        if(n && !allData[currentUser][n]) { allData[currentUser][n] = allData[currentUser][currentSet]; delete allData[currentUser][currentSet]; currentSet = n; document.getElementById('setNameInput').value=""; save(); renderUI(); }
    }

    function handleDeleteSet() {
        if(Object.keys(allData[currentUser]).length > 1 && confirm("Set l√∂schen?")) { delete allData[currentUser][currentSet]; currentSet = Object.keys(allData[currentUser])[0]; save(); renderUI(); }
    }

    function handleCreateSet() { const n = document.getElementById('setNameInput').value; if(n) { allData[currentUser][n] = []; currentSet = n; document.getElementById('setNameInput').value=""; save(); renderUI(); } }
    function changeAppMode(m) { appMode = m; document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active')); document.getElementById('tab-'+m).classList.add('active'); renderUI(); }
    function handleCardFlip() { if(appMode === 'learn') document.getElementById('cardInner').classList.toggle('flipped'); }
    function navigate(s) { const c = getFiltered(); if(c && c.length) { index = (index+s+c.length)%c.length; renderUI(); } }
    function setCardStatus(up) { const c = getFiltered()[index]; if(c) { c.level = up ? Math.min(c.level+1, 5) : 1; save(); navigate(1); } }
    function switchSet() { currentSet = document.getElementById('setSelect').value; index = 0; renderUI(); }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
    function exportJSON() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(allData)], {type:'application/json'})); a.download='VocaPro_Backup.json'; a.click(); }
    function importJSON(e) { const r = new FileReader(); r.onload = ev => { allData = JSON.parse(ev.target.result); save(); renderUI(); }; r.readAsText(e.target.files[0]); }
    
    init();
</script>
</body>
</html>
